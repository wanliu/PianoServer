function parseResponseData(t){var e=["avatar_urls","cover_urls","image_urls"],a=["start_at","end_at"],s=["created_at","updated_at"];for(var n in t)e.indexOf(n)>-1&&(t[n]=JSON.parse(t[n])),a.indexOf(n)>-1&&(t[n]=Date.parse(t[n])),s.indexOf(n)>-1&&(t[n]*=1e3)}function formatZero(t){return 10>+t?"0"+t:t}function formatDate(t){var e=new Date(t),a=e.getFullYear(),s=e.getMonth()+1,n=e.getDate();e.getHours(),e.getMinutes();return[[a,formatZero(s),formatZero(n)].join("-")].join(" ")}var params=getQueryParams(),one_money_id=params.one_money_id||window.one_money_id,item_id=params.id,url=["/api/promotions/one_money/",one_money_id,"/items/",item_id].join(""),beforeAjaxTime=(new Date).getTime(),$action=$(".actions");$.ajax({type:"GET",dataType:"json",url:url,data:{u:beforeAjaxTime},success:function(t){var e=(new Date).getTime(),a=t.td,s=(e-beforeAjaxTime)/2;a-=Math.ceil(s),parseResponseData(t);var n=t.image_urls[0],i=t.ori_price,o=t.title,r=t.shop_name,c=t.start_at,l=t.end_at,u=t.total_amount||0,r=t.shop_name,d=t.shop_avatar_url,m=t.status||"wait",p=t.item_status||null,_=$(".countdown-text"),v="always"===p||"no-executies"===p||"lack-multi-item"==p;if(new CountDown(_,+u,c-a,l-a,m,function(t){if(!v)switch(t){case"started":return $action.html('<button class="purchase-btn">马上抢购</button>');case"end":return $action.html('<div class="end-text">活动已结束</div>')}}),setTimeout(function(){_.parent().show()},1500),$(".ori_price").text(i),$("img.poster").attr("src",n),$(".item-title").text(o),$(".start-end .time-desc").text(["活动时间",formatDate(c),"至",formatDate(l)].join(" ")),$(".supplier-desc .avatar").attr("src",d),$(".supplier-name").text(r),v)return url=["/api/promotions/one_money/",one_money_id,"/callback/",item_id].join(""),void $.ajax({type:"GET",dataType:"json",url:url,success:function(t){var e=t.grabs||[];if(e.length>0){var a=e[0],s=a.status,n=a.callback_url;"pending"===s?$action.html(['<a style="text-decoration:none;" href="',n,'"><div class="always-text">领取奖励</div></a>'].join("")):"created"===s&&$action.html('<div class="always-text" style="background:#F60;">已领取奖品</div>')}else $action.html('<div class="always-text" style="background:#F60;">没有抢购机会了</div>')},error:function(t){console.log(t)}});switch(m){case"wait":return $action.html('<div class="wait-text">请耐心等待</div>');case"started":return $action.html('<button class="purchase-btn">马上抢购</button>');case"end":return $action.html('<div class="end-text">活动已结束</div>');case"suspend":return $action.html('<div class="end-text">已售罄</div>');case"no-executies":return $action.html('<div class="always-text">已经不能再抢此商品了</div>');default:return $action.html('<div class="wait-text">请耐心等待</div>')}},error:function(t,e,a){console.log(e)}});var errorMsgs={always:"您已经抢过了","no-executies":"没有抢购机会了","lack-multi-item":"您已经抢过其他的",insufficient:"已经抢光了"};$action.on("click",".purchase-btn",function(t){t.stopPropagation(),$.ajax({url:"/api/promotions/one_money/"+one_money_id+"/grab/"+item_id,type:"PUT",dataType:"json",success:function(t){if("success"==t.status){var e=t.callback_url;$(".actions").html(['<a style="text-decoration:none;" href="',e,'"><div class="always-text">领取奖励</div></a>'].join("")),AlertDismiss.getAlertDismiss("抢购提示","恭喜您抢购成功！",{buttons:[new ActionButton("领取奖励",t.callback_url,"btn-success")]})}},error:function(t){var e=t.responseJSON,a=e.status;return 401===t.status?AlertDismiss.getAlertDismiss("抢购提示","您尚未 登陆/注册.",{buttons:[new ActionButton("前往 登陆/注册 页面","/authorize/weixin","btn")],msgColor:"#555"}):void AlertDismiss.getAlertDismiss("抢购提示",errorMsgs[a]||"服务器异常")}})});