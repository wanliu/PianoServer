$(function(){function t(t){var e=["avatar_urls","cover_urls","image_urls"],a=["start_at","end_at"],s=["created_at","updated_at"];for(var n in t)e.indexOf(n)>-1&&(t[n]=JSON.parse(t[n])),a.indexOf(n)>-1&&(t[n]=Date.parse(t[n])),s.indexOf(n)>-1&&(t[n]*=1e3)}function e(t){return 10>+t?"0"+t:t}function a(t){var a=new Date(t),s=a.getFullYear(),n=a.getMonth()+1,i=a.getDate();a.getHours(),a.getMinutes();return[[s,e(n),e(i)].join("-")].join(" ")}var s=getQueryParams(),n=s.one_money_id||window.one_money_id,i=s.id,o=["/api/promotions/one_money/",n,"/items/",i].join(""),r=(new Date).getTime(),l=$(".actions");$.ajax({type:"GET",dataType:"json",url:o,data:{u:r},success:function(e){var s=(new Date).getTime(),c=e.td,u=(s-r)/2;c-=Math.ceil(u),t(e);var d=e.image_urls[0],m=e.ori_price,p=e.title,_=e.shop_name,v=e.start_at,h=e.end_at,w=e.total_amount||0,_=e.shop_name,f=e.shop_avatar_url,g=e.status||"wait",x=e.item_status||null,y=$(".countdown-text"),b=e.shop_id,j=["/goshop/",b].join("");$(".shop-link").attr("href",j);var D="always"===x||"no-executies"===x||"lack-multi-item"==x;if(new CountDown(y,+w,v-c,h-c,g,function(t){if(!D)switch(t){case"started":return l.html('<button class="purchase-btn">马上抢购</button>');case"end":return l.html('<div class="end-text">活动已结束</div>')}}),setTimeout(function(){y.parent().show()},1500),$(".ori_price").text(m),$("img.poster").attr("src",d),$(".item-title").text(p),$(".start-end .time-desc").text(["活动时间",a(v),"至",a(h)].join(" ")),$(".supplier-desc .avatar").attr("src",f),$(".supplier-name").text(_),D)return o=["/api/promotions/one_money/",n,"/callback/",i].join(""),void $.ajax({type:"GET",dataType:"json",url:o,success:function(t){var e=t.grabs||[];if(e.length>0){var a=e[0],s=a.status,n=a.callback_url;"pending"===s?l.html(['<a style="text-decoration:none;" href="',n,'"><div class="always-text">领取奖励</div></a>'].join("")):"created"===s&&l.html('<div class="always-text" style="background:#F60;">已领取奖品</div>')}else l.html('<div class="always-text" style="background:#F60;">没有抢购机会了</div>')},error:function(t){console.log(t)}});switch(g){case"wait":return l.html('<div class="wait-text">请耐心等待</div>');case"started":return l.html('<button class="purchase-btn">马上抢购</button>');case"end":return l.html('<div class="end-text">活动已结束</div>');case"suspend":return l.html('<div class="end-text">已售罄</div>');case"no-executies":return l.html('<div class="always-text">已经不能再抢此商品了</div>');default:return l.html('<div class="wait-text">请耐心等待</div>')}},error:function(t,e,a){console.log(e)}});var c={always:"您已经抢过了","no-executies":"没有抢购机会了","lack-multi-item":"您已经抢过其他的",insufficient:"商品库存不足",suspend:"商品已经抢光了",end:"活动已结束","state-invalid":"活动未开始/已结束",total_amount_zero:"本期活动中此商品总库存为0",quantity_zero:"本期活动中此商品的每次抢购个数为0"};l.on("click",".purchase-btn",function(t){t.stopPropagation(),$.ajax({url:"/api/promotions/one_money/"+n+"/grab/"+i,type:"PUT",dataType:"json",success:function(t){if("success"==t.status){var e=t.callback_url;$(".actions").html(['<a style="text-decoration:none;" href="',e,'"><div class="always-text">领取奖励</div></a>'].join("")),AlertDismiss.getAlertDismiss("抢购提示","恭喜您抢购成功！",{buttons:[new ActionButton("领取奖励",t.callback_url,"btn-success")]})}},error:function(t){var e=t.responseJSON,a=e.status;if(401===t.status){var s=[window.one_money_prefix,window.sales_start_date,"/detail.html?one_money_id=",n,"&id=",i].join(""),o=[window.signup_url,"?callback=",encodeURIComponent(s),"&goto_one_money=true"].join("");return AlertDismiss.getAlertDismiss("抢购提示","您尚未 登陆/注册.",{buttons:[new ActionButton("前往 登陆/注册 页面",o)],msgColor:"#555"})}AlertDismiss.getAlertDismiss("抢购提示",c[a]||"服务器异常 "+a,{msgColor:"#555"})}})})});