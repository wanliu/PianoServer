$(function(){function t(t){var e=["avatar_urls","cover_urls","image_urls"],n=["start_at","end_at"],a=["created_at","updated_at"];for(var s in t)e.indexOf(s)>-1&&(t[s]=JSON.parse(t[s])),n.indexOf(s)>-1&&(t[s]=Date.parse(t[s])),a.indexOf(s)>-1&&(t[s]*=1e3)}function e(t){return 10>+t?"0"+t:t}function n(t){var n=new Date(t),a=n.getFullYear(),s=n.getMonth()+1,i=n.getDate();n.getHours(),n.getMinutes();return[[a,e(s),e(i)].join("-")].join(" ")}function a(t,e){var n=r[e];return n&&n.length>0?['<div class="error-msg">',n,"</div>"].join(""):u[t]||'<div class="wait-text">请耐心等待</div>'}function s(t){return['<a style="text-decoration:none;" href="',t,'"><div class="always-text">领取奖励</div></a>'].join("")}function i(t,e,n,i){switch(void 0===typeof n&&(n=""),n){case"pending":return s(i);case"created":return["always","no-executies","lack-multi-item"].indexOf(e)>-1?'<div class="already-award">已领取奖品</div>':a(t,e);default:return a(t,e)}}function o(t,e,n){var a,s;if(n.length>0){var o=n[0];a=o.status,s=o.callback_url}var r=i(t,e,a,s);$(".actions").html(r)}var r={always:"您已经抢过了","no-executies":"没有抢购机会了","lack-multi-item":"您已经抢过其他的",insufficient:"商品库存不足",suspend:"商品已经抢光了",end:"活动已结束","state-invalid":"活动未开始/已结束",total_amount_zero:"本期活动中此商品总库存为0",quantity_zero:"本期活动中此商品的每次抢购个数为0"},u={wait:'<div class="wait-text">请耐心等待</div>',started:'<button class="purchase-btn">马上抢购</button>',end:'<div class="end-text">活动已结束</div>',suspend:'<div class="end-text">已售罄</div>',"no-executies":'<div class="always-text">已经不能再抢此商品了</div>'},c=getQueryParams(),l=c.one_money_id||window.one_money_id,d=c.id,m=["/api/promotions/one_money/",l,"/items/",d].join(""),p=$(".actions"),v=(new Date).getTime();$.ajax({type:"GET",dataType:"json",url:m,data:{u:v},success:function(e){var s=(new Date).getTime(),i=e.td,u=(s-v)/2;i-=Math.ceil(u),t(e);var c=e.image_urls[0],_=e.ori_price,f=e.title,w=e.shop_name,g=e.start_at,x=e.end_at,y=e.total_amount||0,w=e.shop_name,h=e.shop_avatar_url,b=e.status||"wait",j=e.item_status||null,D=$(".countdown-text"),k=e.shop_id,T=["/goshop/",k].join("");$(".shop-link").attr("href",T);var A=r[j];new CountDown(D,+y,g-i,x-i,b,function(t){if(!A)switch(t){case"started":return p.html('<button class="purchase-btn">马上抢购</button>');case"end":return p.html('<div class="end-text">活动已结束</div>')}}),setTimeout(function(){D.parent().show()},1500),$(".ori_price").text(_),$("img.poster").attr("src",c),$(".item-title").text(f),$(".start-end .time-desc").text(["活动时间",n(g),"至",n(x)].join(" ")),$(".supplier-desc .avatar").attr("src",h),$(".supplier-name").text(w),m=["/api/promotions/one_money/",l,"/callback/",d].join(""),$.ajax({type:"GET",dataType:"json",url:m,success:function(t){var e=t.grabs||[];o(b,j,e)},error:function(){a(b,j)}})},error:function(t,e,n){console.log(e)}}),p.on("click",".purchase-btn",function(t){t.stopPropagation(),$.ajax({url:"/api/promotions/one_money/"+l+"/grab/"+d,type:"PUT",dataType:"json",success:function(t){if("success"==t.status){var e=t.callback_url;$(".actions").html(['<a style="text-decoration:none;" href="',e,'"><div class="always-text">领取奖励</div></a>'].join("")),AlertDismiss.getAlertDismiss("抢购提示","恭喜您抢购成功！",{buttons:[new ActionButton("领取奖励",t.callback_url,"btn-success")]})}},error:function(t){var e=t.responseJSON,n=e.status;if(401===t.status){var a=[window.one_money_prefix,window.sales_start_date,"/detail.html?one_money_id=",l,"&id=",d].join(""),s=[window.signup_url,"?callback=",encodeURIComponent(a),"&goto_one_money=true"].join("");return AlertDismiss.getAlertDismiss("抢购提示","您尚未 登陆/注册.",{buttons:[new ActionButton("前往 登陆/注册 页面",s)],msgColor:"#555"})}AlertDismiss.getAlertDismiss("抢购提示",r[n]||"服务器异常 "+n,{msgColor:"#555"})}})})});