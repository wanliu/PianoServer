function parseResponseData(t){var e=["avatar_urls","cover_urls","image_urls"],a=["start_at","end_at"],n=["created_at","updated_at"];for(var s in t)e.indexOf(s)>-1&&(t[s]=JSON.parse(t[s])),a.indexOf(s)>-1&&(t[s]=Date.parse(t[s])),n.indexOf(s)>-1&&(t[s]*=1e3)}function formatZero(t){return 10>+t?"0"+t:t}function formatDate(t){var e=new Date(t),a=e.getFullYear(),n=e.getMonth()+1,s=e.getDate();e.getHours(),e.getMinutes();return[[a,formatZero(n),formatZero(s)].join("-")].join(" ")}var params=getQueryParams(),one_money_id=params.one_money_id||window.one_money_id,item_id=params.id,url=["/api/promotions/one_money/",one_money_id,"/items/",item_id].join(""),beforeAjaxTime=(new Date).getTime(),$action=$(".actions");$.ajax({type:"GET",dataType:"json",url:url,data:{u:beforeAjaxTime},success:function(t){var e=(new Date).getTime(),a=t.td,n=(e-beforeAjaxTime)/2;a-=Math.ceil(n),parseResponseData(t);var s=t.image_urls[0],i=t.ori_price,o=t.title,r=t.shop_name,c=t.start_at,l=t.end_at,u=t.total_amount||0,r=t.shop_name,d=t.shop_avatar_url,m=t.status||"wait",p=t.item_status||null,_=$(".countdown-text");if(new CountDown(_,+u,c-a,l-a,m,function(t){if("always"!==p&&"no-executies"!==p)switch(t){case"started":return $action.html('<button class="purchase-btn">马上抢购</button>');case"end":return $action.html('<div class="end-text">活动已结束</div>')}}),setTimeout(function(){_.parent().show()},1500),$(".ori_price").text(i),$("img.poster").attr("src",s),$(".item-title").text(o),$(".start-end .time-desc").text(["活动时间",formatDate(c),"至",formatDate(l)].join(" ")),$(".supplier-desc .avatar").attr("src",d),$(".supplier-name").text(r),"always"==p||"no-executies"==p)return url=["/api/promotions/one_money/",one_money_id,"/callback/",item_id].join(""),void $.ajax({type:"GET",dataType:"json",url:url,success:function(t){var e=t.grabs;if(e.length>0){var a=e[0],n=a.status,s=a.callback_url;"pending"===n?$action.html(['<a style="text-decoration:none;" href="',s,'"><div class="always-text">领取奖励</div></a>'].join("")):"created"===n&&$action.html('<div class="always-text">已领取奖品</div>')}else $action.html('<div class="always-text">没有抢购机会了</div>')},error:function(t){console.log(t)}});switch(m){case"wait":return $action.html('<div class="wait-text">请耐心等待</div>');case"started":return $action.html('<button class="purchase-btn">马上抢购</button>');case"end":return $action.html('<div class="end-text">活动已结束</div>');case"suspend":return $action.html('<div class="end-text">已售罄</div>');case"no-executies":return $action.html('<div class="always-text">已经不能再抢此商品了</div>');default:return $action.html('<div class="wait-text">请耐心等待</div>')}},error:function(t,e,a){console.log(e)}}),$action.on("click",".purchase-btn",function(t){t.stopPropagation(),$.ajax({url:"/api/promotions/one_money/"+one_money_id+"/grab/"+item_id,type:"PUT",dataType:"json",success:function(t){if("success"==t.status){var e=t.callback_url;$(".actions").html(['<a style="text-decoration:none;" href="',e,'"><div class="always-text">领取奖励</div></a>'].join("")),AlertDismiss.getAlertDismiss("抢购提示","恭喜您抢购成功！",{buttons:[new ActionButton("领取奖励",t.callback_url,"btn-success")]})}},error:function(t){switch(console.log(t),t.status){case 401:return AlertDismiss.getAlertDismiss("抢购提示","您尚未 登陆/注册.",{buttons:[new ActionButton("前往 登陆/注册 页面","/authorize/weixin","btn")]});default:return AlertDismiss.getAlertDismiss("抢购提示","抢购失败, 请稍后再试.")}}})});