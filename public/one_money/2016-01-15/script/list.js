$(function(){function t(t,s){var a=["avatar_urls","cover_urls","image_urls"],e=["start_at","end_at"];for(var n in t){var i=t[n];a.indexOf(n)>-1&&(i=JSON.parse(i)),e.indexOf(n)>-1&&(i=Date.parse(i)-s),this[n]=i}this.render(),this.countDownTime()}var s=window.one_money_id||1,a=(new Date).getTime(),e=getQueryParams();e.status&&$.ajax({url:"/api/promotions/one_money/"+window.one_money_id+"/signup",type:"PUT",dataType:"json",success:function(){},error:function(){}}),$.ajax({url:"/api/promotions/one_money/"+s+"/items?u="+a,success:function(s){var e=(new Date).getTime(),n=Math.ceil(s.td+(e-a)/2),i=s.items||[];i.map(function(s){new t(s,n)})},error:function(t){console.log(t),$("body").append('<h1 style="color:#FFF;text-align:center;margin-top:80px">无法获取服务器数据</h1>')}}),t.prototype={getStatus:function(){var t=(new Date).getTime();return"timing"!=this.status?this.status:this.total_amount<1?"suspend":t<this.start_at?"wait":t>this.end_at?"end":"started"},changeStatus:function(t){$(".promotion-item[name="+this.id+"] .status-wrap").html(this.statusFlagTemplate(t))},countDownTime:function(){function t(){var n=(new Date).getTime();return n>a.end_at&&"end"!=s?(s="end",e.removeHandler(t),a.changeStatus("end")):n>a.start_at&&"started"!=s?(s="started",a.changeStatus("started")):void 0}var s=this.getStatus();if("end"!=s&&"suspend"!=s){var a=this,e=CountDownManager.getManager();e.addHandler(t)}},statusFlagTemplate:function(t){var t=t||this.getStatus(),s=this.completes||0,a=this.total_amount;switch(a-=s,t){case"wait":return'<span class="status wait">未开始</span>&emsp;活动数量:'+this.total_amount;case"end":return'<span class="status end">已结束</span>&emsp;活动数量:'+this.total_amount;case"suspend":return'<span class="status end">已售罄</span>&emsp;活动数量:'+this.total_amount;case"started":return'<span class="status">抢购中</span>&emsp;活动数量:'+this.total_amount}},template:function(){return'        <li class="promotion-item" name='+this.id+'>          <a class="item-wrap" href="detail.html?one_money_id='+this.one_money_id+"&id="+this.id+'">            <header>              <img class="one-money-logo" src="./images/one_money_log.jpg"/>              <img class="cover" src="'+this.cover_urls[0]+'">              <div class="limit">              </div>            </header>            <main>              <p class="title">'+this.title+'</p>              <div class="price-wrap">                <span class="now-price">￥'+this.price+'</span>                <span class="origin-price">原价<s>￥'+this.ori_price+'&nbsp;</s></span>              </div>              <div class="status-wrap">'+this.statusFlagTemplate()+"</div>            </main>          </a>        </li>"},render:function(t){var t=t||$(".promotions-list");t.append(this.template())}}});