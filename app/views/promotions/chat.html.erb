<%= content_for :title, @shop.name %>
<%= nav_back_button %>
<%= content_for :module, :piano %>

<div class="chat-list">
  <div class="chat-order" data-order-id="<%= @order.id %>">
    <%= image_tag @order.avatar_url, class: "chat-order-image", "state-load-url" => status_of_promotion_path(@promotion, @order) %>
    <h2><%= @order.title %></h2>
    <%= @order.id %>
  </div>  
  <div class="chat-inner" >
  </div>
</div>
<nav class="chat-navbar navbar navbar-default navbar-fixed-bottom">
  <div class="container">
    <form class="navbar-form navbar-left" role="search" onsubmit="return false;">
      <button type="submit" class="btn btn-default pull-right">发送</button>
      <div class="form-group">
        <input type="text" class="form-control" placeholder="输入您要说的话..." name="chat-text">
      </div>
    </form>
  </div>
</nav>

<script type="text/javascript">
  $(function() {
    var ownerId = "<%= @shop.owner_id %>",
        StatusLoadUrl = window.StatusLoadUrl;
        promotionId = "<%= @promotion.id %>",
        userSocket = window.userSocket,
        ownId = userSocket.userId,
        channelId = userSocket.getUserChannelId(),
        chatChannelId = 'p' + ownerId,
        $list = $('.chat-list'),
        fromTime;

    userSocket.offPersonMessage(insertMessage);
    userSocket.onPersonMessage(insertMessage);

    userSocket.emit('getChannelMessage', {
      'channelId': chatChannelId,
      'type': 'index',
      'start': 0
    }, function(err, messages) {
      if (err || messages.length === 0) {
        return;
      }

      for(var i=0; i <messages.length; i++) {
        insertMessage(messages[i]);
      }

      if (messages.length < 10) {
        $list.find('.load-more').remove();
      } else {
        fromTime = messages[0].time;
        insertLoadMore();
      }
    });


    function insertMessage (message) {
      var senderId = message.senderId,
          isOwnSend = ownId === senderId,
          content = message.content,
          avatar = message.senderAvatar,
          username = message.senderLogin || '游客',
          toAddClass = isOwnSend ? 'you' : 'me',
          avatar = avatar === '' ? '<%= image_path "avatar.gif" %>' : avatar,
          htmlAry = ['<div class="chat ', toAddClass, '"><img src="', avatar, '">',
            '<h2>', username, '</h2><div class="bubble ', toAddClass, '"><p>',
            content, '</p></div></div>'],
          pathname = window.location.pathname;

      if (pathname === '/promotions/' + promotionId + '/chat') {
        $(htmlAry.join('')).appendTo($list);

        resetScroll();
      } else {
        window.noticeCenter.addNotice(senderId, username, promotionId);
      }
    }

    function insertLoadMore() {
      $('<div class="load-more">查看更多消息</div>')
        .click(function() {
          $(this).hide().parent().prepend('<div class="record-loading"><span class="loading-icon"/>正在加载聊天记录</div>');

          userSocket.emit('getChannelMessage', {
            'channelId': chatChannelId,
            'type': 'time',
            'start': fromTime
          }, function(err, messages) {
            if (err) {
              return;
            }

            $list.find('.record-loading').remove();  

            if (messages.length < 10) {
              $list.find('.more-record').remove();

              if( messages.length === 0) {
                return;
              }
            }

            for(var i=messages.length-1; i>=0; i--) {
              insertMessage(messages[i]);
            }

            $list[0].scrollTop = 0;

            fromTime = messages[0].time;
          });
        }).prependTo($list);
    }

    function resetScroll() {
      var ele = $list[0],
          clientHeight = ele.clientHeight,
          scrollHeight = ele.scrollHeight,
          offset = scrollHeight - clientHeight;
          
      if (offset > 0) {
        ele.scrollTop = offset;
      }
    }

    $('.chat-navbar button').click(function() {
      var $input = $("input[name='chat-text']"),
          text = $.trim($input.val()),
          channelId = 'p' + ownerId;

      $input.val('');

      if (text.length > 0) {
      <% if Settings.debug %>
        insertMessage(text);
      <% else %>
        var socket = window.userSocket;

        socket.publish(channelId, {
          'content': text,
          'promotionId': promotionId,
          'attachs': {}
        });      
      <% end %>        
      }
    });

    // var orderId = $('.chat-order ').data("orderId");
    var $img = $('.chat-order>img:first-child')[0];
    var stateLoad = new StatusLoadUrl($img);
  });
</script>
