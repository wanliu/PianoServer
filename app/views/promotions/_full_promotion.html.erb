<%= content_for :title, @shop.name %>
<%= nav_back_button %>
<%= content_for :module, :detail %>

<div class="promotion-detail-container" data-promotion-id="<%= promotion.id %>" >
  <%= image_tag(promotion.image_url, class: "promotion-poster") %>

  <div class="price-period clearfix">
    <div class="price-desc">
      <div class="promotion-price">
        ￥<%= promotion.discount_price %>
      </div>
      <div class="dicount-desc">
        <p><s>￥<%= promotion.product_price %></s></p>
        <span class="desc-text">
          <% if promotion.type == 'promotions/discount' %>
            <%= promotion.discount %>销售
          <% elsif promotion.type == 'promotions/time_limited_sale' %>
            限时抢购
          <% end %>
        </span>
      </div>
    </div>

    <% if promotion.status === 'Published' %>
    <div class="period-desc not-started">
      <div class="desc-wrap">
        <p>活动开始时间</p>
        <%= promotion.start_time.to_datetime.in_time_zone('Beijing').strftime('%Y/%m/%d %H:%M')%>
      </div>
    </div>
    <% elsif promotion.status === 'Active' %>
    <div class="period-desc started">
      <div class="desc-wrap">
        <% if promotion.type == 'promotions/time_limited_sale'%>
          <p>距活动结束</p>
        <% else %>
          <p>库存剩余<%= promotion.product_inventory %>件</p>
        <% end %>
      </div>
    </div>
    <% else %>
    <div class="period-desc finished">
      <div class="desc-wrap">
        活动结束
      </div>
    </div>
    <% end %>
  </div>

  <div class="title-contact">
    <div class="promotion-title"><%= promotion.title %></div>
    <div class="promotion-favors">
      <p>收藏</p>
      <%= promotion.likers_count%>
    </div>
    <div class="promotion-likers">
      <p>赞</p>
      <%= promotion.favoriters_count %>
    </div>
  </div>

  <div class="shop-brief clearfix">
    <div class="shop-logo">
       <%= image_tag shop.logo_url %>
    </div>

    <div class="shop-desc">
      <p>供应商:<%= shop.name %></p>
      <p>地址:<%= shop.address %></p>
      <p>关注:100<button class="btn btn-follow"><span class="glyphicon glyphicon-plus"/>关注</button></p>
    </div>
  </div>

  <div class="product-brief">
    <div class="row">
      <div class="col-xs-7 col-md-7">
        <p>品&nbsp;&nbsp;牌：高端大气上档次</p>
      </div>
      <div class="col-xs-5 col-md-5">
        <p class="text-right">活动销量：1000</p>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-7 col-md-7">
        <p>数&nbsp;&nbsp;量：</p>
      </div>
      <div class="col-xs-5 col-md-5">
        <p class="text-right">库存：<%= promotion.product_inventory %>件</p>
      </div>
    </div>
  </div>

  <div class="navbar-bottom navbar navbar-default navbar-fixed-bottom">
    <div class="link-table">
      <%= link_to shop_site_path(shop_name: promotion.shop_name), class: "contact-button into-shop" do %>
        <span class="button-icon glyphicon glyphicon-home" aria-hidden="true"></span>
        <div class="button-text">商家</div>
      <% end %>

      <% if promotion.favorited %>
        <div class="fav-button favorited contact-button">
          <span class="button-icon glyphicon glyphicon-star" aria-hidden="true"></span>
          <div class="button-text">已收藏</div>
        </div>
      <% else %>
        <div class="fav-button contact-button">
          <span class="button-icon glyphicon glyphicon-star-empty" aria-hidden="true"></span>
          <div class="button-text">收藏</div>
        </div>
      <% end %>

      <div class="into-cart contact-button">
        <span class="glyphicon glyphicon-shopping-cart" aria-hidden="true"></span>
        <div class="button-text">购物车</div>
      </div>

      <div class="buy-now contact-button">购买</div>

      <% if shop.owner.id === current_anonymous_or_user.id %>
 	      <div class="chat contact-button">您的店铺</div>
      <% else %>
        <%= link_to '洽谈', promotion_chats_path(promotion, shop_id: @shop.id), class: "chat contact-button", method: 'POST' %>
      <% end %>
    </div>
  </div>
</div>

<script type="text/javascript">
  $(function() {
    $('.fav-button').click(function() {
      var $this = $(this),
          promotionId = $('.promotion-detail-container').data('promotionId'),
          isFavorited = $this.hasClass('favorited');

      $.ajax({
        type: 'PUT',
        url: '/promotions/' + promotionId + '/favorited',
        dataType: 'json'
      }).done(function() {
        $this.toggleClass('favorited')
             .find('.button-icon')
             .toggleClass('glyphicon-star glyphicon-star-empty')
             .end()
             .find('.button-text')
             .text(isFavorited ? '收藏' : '已收藏');
      });
    });
  });
</script>
