<div class="page-header col-sm-12 ">
  <h1>购物车 <small>清单</small></h1>
</div>

<div class="col-sm-12">
  <% if current_cart.items.blank? %>
    <h2>你的购物车是空的</h2>
  <% else %>
    <% groups = @items.group_by {|item| item.supplier } %>
    <% groups.each do |supplier, items| %>
      <%= form_for Order.new do |f| %>
        <%= f.hidden_field :supplier_id, value: supplier.id %>
        <div class="panel panel-default">
          <div class="panel-heading">
            <div class="btn-group pull-right">
              <%#= link_to '#', class: 'btn btn-link' do %>
                <%= caret %>
              <%# end %>
            </div>
            <span>
              <input type='checkbox' class='select-all' data-supplier-id='<%= supplier.id %>' checked='checked' />全选
            </span>
            店铺：
            <%= link_to shop_site_path(supplier.name) do %>
              <%= supplier.title %> 
            <% end %>
            ( <%= items.count %> 件商品)
          </div>
          <ul class="list-group cart-item-details">
            <%= render partial: "cart_item", collection: items.sort_by(&:id), as: :item, locals: { supplier: supplier, f: f } %>
          </ul>
          <div class="panel-footer">
            <%= f.submit '生成订单', class: 'btn btn-primary' %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% end %>

  <%#= button_to '全部生成订单', class: 'btn btn-primary' %>

</div>

<script type="text/javascript">
  (function (argument) {
    $('.select-all').change(function (event) {
      var checked = $(this).prop('checked');
      $(this).parents('form').find(':checkbox').prop('checked', checked);
    });

    $('.cart-item input[name=quantity]').keyup(function (event) {
      changeQuantity(this)
    });

    $('.cart-item').on('click', '.btn-minus', function (event) {
      var quantityInput = $(this).parents('.quantity').find('input');
      var quantity = 1 * $(quantityInput).val();
      $(quantityInput).val(quantity - 1);

      changeQuantity(quantityInput); 
    });

    $('.cart-item').on('click', '.btn-plus', function (event) {
      var quantityInput = $(this).parents('.quantity').find('input');
      var quantity = 1 * $(quantityInput).val();
      $(quantityInput).val(quantity + 1);
  
      changeQuantity(quantityInput); 
    });

    function changeQuantity(quantityInput) {
      var cartItemId = $(quantityInput).parents('.cart-item').data('cartItemId');
      var quantity = $(quantityInput).val();

      var $subTotal = $(quantityInput).parents('.quantity').siblings('.subtotal');
      var $btnMinus = $(quantityInput).parents('.quantity').find('.btn-minus span');
    
      if ('' == quantity) return;

      if (!/^\d+$/.test(quantity)) {
        $(quantityInput).val(1);
        quantity = 1;
      }

      quantity = 1 * quantity;

      if (quantity > 1) {
        $btnMinus.addClass('glyphicon-minus');
      } else {
        $btnMinus.removeClass('glyphicon-minus');
      }

      $.post('/cart_items/' + cartItemId, {
        _method: 'PATCH',
        cart_item: {
          quantity: quantity,
        }
      }).done(function (data, xhr, status) {
        $subTotal.text(data.sub_total);
      }).fail(function (data, xhr, status) {
        // TODO
      })
    }
  })();
</script>

