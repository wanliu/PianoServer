<% saleable = item.cartable.saleable?(item.quantity, item.properties) %>

<tr class="cart-item <%= saleable ? 'saleable' : 'unsaleable' %>" data-cart-item-id="<%= item.id %>">
  <td class='avatar'>
    <div class='media'>
      <div class='media-left'>
        <% if saleable %>
          <%= f.check_box "cart_item_ids", {multiple: true, checked: true}, item.id, nil %>
        <% else %>
          <span class='unsaleable'>失效</span>
        <% end %>      
      </div>
      <div class='media-left'>
        <%= link_to cartable_url(item) do %>
          <%= image_tag item.avatar_url, class: 'media-object', alt: "商品图片" %>
        <% end %>
      </div>
      <div class='media-body'>
        <%= "#{item.title} #{item.properties_title}" %>
      </div>
    </div>
  </td>
  <td  class="price">
    <%= number_to_currency item.price %>
  </td>
  <td>
    <% if saleable %>
      <div class="quantity">
        <div class="input-group">
          <span class="input-group-btn">
            <button type="button" class="btn btn-minus">
              <% if item.quantity > 1 %>
                <span class="glyphicon glyphicon-minus"></span>
              <% else %>
                <span class="glyphicon"></span>
              <% end %>
            </button>
          </span>
          <input type="text" name="quantity" class="form-control input-number" value=<%= number_with_delimiter item.quantity %> autocomplete="off">
          <span class="input-group-btn">
            <button type="button" class="btn btn-plus">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
          </span>
        </div>
        <div class="alert alert-danger fade in" role="alert" style='display: none;'>
          <p>最多只能购买<span class='max-quantity'></span>件</p>
        </div>
      </div>

    <% else %>
      <span><%= number_with_delimiter item.quantity %></span>
    <% end %>
  </td>
  <td class="subtotal">
    <%= number_to_currency item.price * item.quantity %>
  </td>
  <td class="operations">
    <%= link_to "移出购物车", item, method: :delete, data: { confirm: '确定删除这个商品么？' } %>
  </td>
</tr>
<% if item.cartable.try(:gifts).present? %>
  <tr class='cart-gifts'>
    <td colspan='5'>
      <% item.cartable.gifts.each do |gift| %>
        <% quantity = gift.available_quantity(item.quantity) %>
        <% if quantity > 0 %>
          <div class='cart-gift'>
            <div class='head'>
            </div>
            <div class='desc'>
              <div class='avatar'>
                <%= image_tag gift.avatar_url %>
              </div>
              <div class='title-quantity'>
                <div class='title'>
                  <span>
                    <%= "#{gift.present.title} #{gift.properties_title}" %>
                  </span>
                </div>
                <div class='quantity'>
                  <span>数量：<%= quantity %></span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </td>
  <tr>
<% end %>
