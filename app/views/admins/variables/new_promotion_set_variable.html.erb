<div class="promotion-set-variable" >
  <%= form_for @variable, as: :variable, url: variables_path(@subject, @template) do |f| %>
    <%= f.hidden_field :promotion_string %>

    <div class="form-group">
      <%= f.text_field :name, class: "form-control", placeholder: "活动集名" %>
    </div>
    <div class="promotion-set">
      <div class="promotion-list">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <%= f.hidden_field :type, value: @variable.class.name.underscore %>
        <div class="list-group">
          <%= render partial: "promotion_item", collection: @promotions %>
        </div>
      </div>
      <div class="promotion-selected">
        <label class="control-label">
          已选择的活动：
        </label>
        <ul class="selected-promotions">

        </ul>
      </div>
    </div>
  <% end %>
</div>

<script type="text/javascript">
    var $seleteds = $('.selected-promotions'),
        $list = $('.promotion-set-variable .list-group'),
        $ids = $('#variable_promotion_string');

    function removePromotionId(id) {
      var ids = $ids.val().split(','),
          index = ids.indexOf(id);

      if (index > -1) {
        ids.splice(index, 1);

        $ids.val(ids.join(','));
      }
    }

    function addPromotionId(id) {
      var ids = $ids.val();

      $ids.val(ids !== '' ?  [ids, id].join(',') : id);
    }

    $list.on('click', '.promotion', function(event) {
      var $target = $(event.currentTarget),
          id = $target.find('.id').text(),
          title = $target.find('.title').text();

      if ($target.hasClass('active')) {
        $target.removeClass('active');

        $seleteds.find('li#' + id).remove();

        removePromotionId(id);
      } else {
        $target.addClass('active');

        var html = ['<li class="selected-promotion" id="', id, '" ><div class="promotion-name">', title, '</div><div class="remove-promotion"><span class="glyphicon glyphicon-remove"></span></div>', '</li>'];

        $(html.join('')).appendTo($seleteds);

        addPromotionId(id);
      }
    });

    $seleteds.on('click', '.remove-promotion', function(event) {
      var $target = $(event.target),
          $selected = $target.parents('.selected-promotion:first'),
          pid = $selected.attr('id');

      $selected.slideUp('fast', function() {
        $(this).remove();

        removePromotionId(pid);

        $list.find('.promotion[data-id=' + pid +']').removeClass('active');
      });
    });
</script>
