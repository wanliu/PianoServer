<% content_for :javascripts do %>
  <%= javascript_include_tag "http://res.wx.qq.com/open/js/jweixin-1.0.0.js" %>
<% end %>

<div class='container'>
  <pre>微信支付 <%= JSON.pretty_generate @params %></pre>
</div>

<% if @params.present? %>
  <script>
    <% signature = Wechat.api.jsapi_ticket.signature request.original_url %>
    wx.config({
      debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
      appId: '<%= Settings.wx_pay.appid %>', // 必填，公众号的唯一标识
      timestamp: <%= signature["timestamp"] %>, // 必填，生成签名的时间戳
      nonceStr: '<%= signatrue["noncestr"] %>', // 必填，生成签名的随机串
      signature: '<%= signatrue["signature"] %>',// 必填，签名，见附录1
      jsApiList: ['chooseWXPay', 'onMenuShareTimeline'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });

    wx.ready(function(){
      function onBridgeReady(){
        alert("..start.. pay fn" + "typeof WeixinJSBridge" + typeof WeixinJSBridge);
        alert("..start.. pay fn" + "WeixinJSBridge.invoke" + typeof WeixinJSBridge.invoke);
        // alert("<%= @params.to_json.html_safe %>");
        var WXPayment = function() {
          if( typeof(WeixinJSBridge) === 'undefined' ) {
              alert('请在微信在打开页面！');
              return false;
          }
          // getBrandWCPayRequest
          WeixinJSBridge.invoke('getBrandWCPayRequest', <%= @params.to_json.html_safe %>, function(res) {
            alert(JSON.stringify(res));
            switch(res.err_msg) {
              case 'get_brand_wcpay_request:cancel':
                alert('用户取消支付！');
                break;
              case 'get_brand_wcpay_request:fail':
                alert('支付失败！（'+res.err_desc+'）');
                break;
              case 'get_brand_wcpay_request:ok':
                alert('支付成功！');
                break;
              default:
                alert(JSON.stringify(res));
                break;
            }
          });
        }
      }
    });
  </script>
<% else %>
  请求已经过时，请返回上级重新开始！
<% end %>