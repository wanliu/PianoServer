<tr class="cart-item" data-cart-item-id="buy-now-item">
  <td class='avatar'>
    <div class='media'>
      <div class='media-left'>
        <%= link_to orderable_url(item) do %>
          <%= image_tag item.avatar_url, class: 'media-object', alt: "商品图片" %>
        <% end %>
      </div>
      <div class='media-body'>
        <%= "#{item.title} #{item.properties_title}" %>
      </div>
    </div>
  </td>
  <td class="price">
    <%= number_to_currency item.price %>
  </td>
  <td class="quantity">
    <%= minus_plus_button_field "order[items_attributes][0]", :quantity, value: item.quantity, placeholder: "数量", class: 'form-control cart_item_quantity' %>
  </td>
  <td class="subtotal">
    <%= number_to_currency item.price * item.quantity %>
  </td>
</tr>

<% if item.orderable.try(:gifts).blank? %>
  <%= hidden_field_tag "order[item_gifts][#{item.orderable.id}][undefined]", nil, { multiple: true } %>
<% else %>
  <% item.orderable.gifts.each do |gift| %>
    <%= hidden_field_tag "order[item_gifts][#{item.orderable.id}][#{gift.id}]", gift.available_quantity(item.quantity), { multiple: true } %>
  <% end %>
<% end %>

<% has_gifts = item.orderable.try(:gifts).present? %>
<tr class='cart-gifts' data-cart-item-id="buy-now-item" style="<%= has_gifts ? '' : 'display: none' %>">
  <td colspan='5'>
    <% if has_gifts %>
      <% item.orderable.gifts.each do |gift| %>
        <% quantity = gift.available_quantity(item.quantity) %>
        <% if quantity > 0 %>
          <div class='cart-gift'  data-gift-id="<%= gift.id %>">
            <div class='head'>
            </div>
            <div class='desc'>
              <div class='avatar'>
                <%= image_tag gift.avatar_url %>
              </div>
              <div class='title-quantity'>
                <div class='title'>
                  <span>
                    <%= "#{gift.present.title} #{gift.properties_title}" %>
                  </span>
                </div>
                <div class='quantity'>
                  <span>数量：<%= quantity %></span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </td>
<tr>