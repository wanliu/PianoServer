<%= content_for :title, @target.try(:nickname) || @target.try(:name) %>
<%= nav_back_button %>
<%= content_for :module, :chat %>

<%= render "chat_order_header" %>
<div class="container chat-order-body">
  <div class="row">
    <div class="order-table-wrap col-sm-6 col-xs-12">
      <div class="order-table">
        <%= render "chat_order_table" %>
      </div>
      <div class="order-buttons clearfix">
        <div class="buttons-execute">
          <div class="col-sm-6 col-xs-6 btn-wrap left">
            <button class="btn btn-confirm-order">确认订单</button>
          </div>
          <div class="col-sm-6 col-xs-6 btn-wrap right">
            <button class="btn btn-help">帮助</button>
          </div>
        </div>
        <div class="buttons-consult">
          <div class="col-sm-6 col-xs-6 btn-wrap left">
            <button class="btn btn-agrees">按住3秒同意</button>
          </div>
          <div class="col-sm-6 col-xs-6 btn-wrap right">
            <button class="btn btn-disagrees">拒绝</button>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-list col-sm-6 col-xs-12">
      <div class="chat-inner" >
        <div class="message-list clearfix">
        </div>
      </div>

      <%= render "chat_input" %>
    </div>

    <%= render "chat_linkmen" %>
  </div>
</div>

<script type="text/javascript">
  $(function() {
    var StatusLoadUrl = window.StatusLoadUrl,
        MiniTable     = window.MiniTable,
        Chat          = window.Chat,
        userSocket    = window.userSocket,
        buyerId       = '<%= @order.buyer_id %>',
        chatChannelId,
        targetId;

    <% unless @target.nil? %>
      targetId  = "<%= @target.id %>";
      chatChannelId = 'p' + targetId;
    <% end %>

    Chat.defaultOptions.avatarDefault = '<%= image_path "avatar.gif" %>';
    var $img = $('.chat-order-image')[0];
    var stateLoad = new StatusLoadUrl($img);

    <% unless @order.nil? %>
    var order = <%=raw @order.origin_hash.to_json %>;
      <% if Settings.dev.feature.order.chat %>
      var miniTable = new MiniTable($('.chat-order-header'), $('.order-table-wrap'), order);
      <% end %>
    <% end %>

    if (!targetId) {
      alert('无效的聊天对象！');
      $('.btn-send').attr('disabled', 'disabled');
      return;
    }

    var chat = new Chat($('.chat-order-header'), chatChannelId, {
      sendBtn: $('.btn-send')
    });

    chat.enter();

    <% if Settings.dev.feature.order.chat %>
    chat.setTable(miniTable);
    <% end %>

    chat.on('init', function(e, socket) {
      var chatId = '<%= @chat.id %>';
      socket.emit('set', { channelId: chatChannelId, key: 'chat_id', value: chatId });

      <% unless @order.nil? %>
      var orderId = '<%= @order.id %>';
      socket.emit('set', { channelId: chatChannelId, key: 'order_id', value: orderId })
      <% end %>
    });

    $(document).on('page:before-unload', function() {
      chat.leave();
    });


    <% if Settings.dev.feature.linkmen %>
      var hammer = new Hammer.Manager($('body')[0]),
          chatListShown = $(window).width() > 867;

      hammer.add(new Hammer.Swipe({
        direction: Hammer.DIRECTION_HORIZONTAL,
        velocity: 0.2
      }));

      hammer.on('swipeleft', function(event) {
        var $target = $(event.target);

        if ($target.is('.order-table .list-group-item') || $target.parents('.order-table .list-group-item').length > 0) {
          return;
        }

        var width = $(window).width();

        if (width <= 867) {
          chatListShown = false;

          $('.chat-linkman-container').animate({
            'left': '-80%'
          }, 250, function() {
            $('.linkmen-overlayer').hide();
          });
        }
      });

      hammer.on('swiperight', function(event) {
        var $target = $(event.target);

        if ($target.is('.order-table .list-group-item') || $target.parents('.order-table .list-group-item').length > 0) {
          return;
        }

        var width = $(window).width();

        if (width <= 867) {
          chatListShown = true;

          $('.chat-linkman-container').animate({
            'left': '0'
          }, 250, function() {
            $('.linkmen-overlayer').show();
          });
        }
      });

      $(window).resize(function() {
        var width = $(window).width();

        if (width > 867) {
          $('.chat-linkman-container').css('left', '-60px');
          $('.linkmen-overlayer').hide();
        } else {
          $('.chat-linkman-container').css('left', chatListShown ? '0' : '-80%');

          if (chatListShown) {
            $('.linkmen-overlayer').show();
          }
        }
      });

      $('.chat-linkman-container .remove-linkman').on('click', function(event) {
        event.preventDefault();
        event.stopPropagation();

        $(this).parent().slideUp('fast', function() {
          $(this).remove();
        });
      });
    <% end %>
  });
</script>
