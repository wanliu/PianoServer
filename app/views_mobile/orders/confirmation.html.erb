<% content_for :module do "no_footer" end %>

<div class='order-confirm order-confirm-mobile toggle-siblings'>
  <%= render "orders/partials/address" %>

  <div class='envelope-border'></div>

  <%= form_for @order do |f| %>
    <%= f.hidden_field :address_id %>
    <%= f.hidden_field :supplier_id %>

    <% @order_items.each do |cart_item| %>
      <% if cart_item.cartable.try(:gifts).blank? %>
        <%= hidden_field_tag "order[cart_item_gifts][#{cart_item.id}][undefined]", nil, { multiple: true } %>
      <% else %>
        <% cart_item.cartable.gifts.each do |gift| %>
          <%= hidden_field_tag "order[cart_item_gifts][#{cart_item.id}][#{gift.id}]", gift.eval_available_quantity(cart_item.quantity), { multiple: true } %>
        <% end %>
      <% end %>
    <% end %>

    <div class='items-container'>
      <div class='header'>
        <span class='shop'>
          <%= link_to shop_site_path(@supplier.name) do %>
            <%= image_tag @supplier.avatar_url %><%= @supplier.title %>
          <% end %>
        </span>
      </div>

      <%= render partial: "confirmation_item", collection: @order_items.sort_by(&:id), as: :order_item, locals: { supplier: @supplier, f: f } %>

      <div class='footer confirmation-total'> 
        <%= render "confirmation_total" %>
      </div>

      <div class='footer'>
        <td colspan='5' class='text-right'>
          <%= link_to "返回购物车", cart_path, class: 'cancel' %>
          <%= f.submit "提交订单", class: 'submit'%>
        </td>
      </div>
    </div>
  <% end %>
</div>

<div class="address-list toggle-siblings" style='display: none;'>
</div>

<div class="new-address toggle-siblings" style='display: none;'>
</div>

<script type="text/javascript">
  (function(){
    $('.more').click(function(event) {
      $(this).siblings('.gifts')
        .toggleClass('toggle-more-gifts');
    })

    $(document).on('click', '.order-confirm-mobile .yiyuan-confirm-location', function (event) {
      event.preventDefault();

      var url = "<%= chose_order_address_orders_path %>"
      // window.location.href = url;
      $.get(url, {format: 'js'})
    });

    $(document).on('click', '.new-yiyuan-address a', function(event) {
      event.preventDefault();

      var url = $(this).attr('href');
      $.get(url, {format: 'js'})
    })

    // $(document).on('submit', '#new_location', function(event) {
    //   event.preventDefault();

    //   var url = $(this).attr('action');
    // });

    window.onpopstate = function(event) {
      var showClass = event.state.show;

      if (showClass) {
        var $showClass = $('.' + showClass);

        $showClass.siblings('.toggle-siblings').hide();
        $showClass.show();
      }
    };

    $(document).on('click', '.locations .yiyuan-address-item', function(event) {
      var location_id = $(this).closest('.yiyuan-address-item').data("addressId");
      $.get('/orders/chose_address?location_id=' + location_id, {format: 'js'});
    });

    history.replaceState({show: "order-confirm-mobile"}, null);
  })();
</script>